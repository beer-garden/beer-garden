version: '3.5'

x-definitions: &common-env
    # IMPORTANT!!
    # Comment this out when using the "secure" compose file
    BG_SSL_ENABLED: "False"

    BG_HOST: beer-garden
    BG_CA_CERT: /certs/ca_certificate.pem

x-definitions: &complex-env
    DB_NAME: complex
    DB_PASS: supersecret

x-definitions: &plugin
    image: bgio/example-plugins
    networks:
        - bg-network
        - rabbit
        - mongo
    stop_signal: SIGINT
    deploy:
        restart_policy:
            condition: any
        replicas: 3
    volumes:
        - ./data/certs/ca_certificate.pem:/certs/ca_certificate.pem
    environment:
        <<: *common-env


services:
    child:
        command: ["child"]
        <<: *plugin

    complex-c1:
        command: ["complex", "instance_name=c1", "c1-host", "c1-port"]
        environment:        
            <<: [*common-env, *complex-env]
            BG_INSTANCE_NAME: c1

        <<: *plugin

    complex-c2:
        command: ["complex", "instance_name=c2", "c2-host", "c2-port"]
        environment:
            <<: [*common-env, *complex-env]
            BG_INSTANCE_NAME: c2
        <<: *plugin

    custom-display:
        command: ["custom_display"]
        <<: *plugin

    dynamic-d1:
        command: ["dynamic"]
        environment:
            BG_INSTANCE_NAME: d1
            <<: *common-env
        <<: *plugin

    dynamic-d2:
        command: ["dynamic"]
        environment:
            BG_INSTANCE_NAME: d2
            <<: *common-env
        <<: *plugin

    echo:
        command: ["echo"]
        <<: *plugin

    echo-sleeper:
        command: ["echo_sleeper"]
        <<: *plugin

    error:
        command: ["error"]
        <<: *plugin

    nested-calls:
        command: ["nested_calls"]
        <<: *plugin

    parent:
        command: ["parent"]
        <<: *plugin

    publisher:
        command: ["publisher"]
        <<: *plugin

    sleeper:
        command: ["sleeper"]
        <<: *plugin

    sleeper-solo:
        command: ["sleeper_solo"]
        <<: *plugin

    subscribe:
        command: ["subscribe"]
        <<: *plugin

networks:
    bg-network:
        name: bg-network
        external: true
    rabbit:
        name: rabbit
        external: true
    mongo:
        name: mongo
        external: true
