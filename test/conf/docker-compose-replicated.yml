version: '3.8'

services:
    beer-garden:
        image: bgio/beer-garden:unstable
        hostname: beergarden{{.Task.Slot}}
        deploy:
            restart_policy:
                condition: any
            replicas: 3
        networks:
            - bg-network
            - rabbit
            - mongo
        ports:
            - "2337:2337"
            - "2338:2338"

        volumes:
            - ./data/logging-config.yaml:/src/example_configs/logging-config.yaml
            - ./data/localplugins:/plugins

        healthcheck:
            test: ["CMD", "curl", "http://localhost:2337/config"]
            start_period: 60s

        environment:
            TZ: UTC

            BG_GARDEN_NAME: docker-replicated
            BG_REPLICATION_ENABLED: "true"

            # Point at the correct database
            BG_DB_HOST: mongodb
            BG_DB_NAME: beer_garden_v3

            # Point at the correct rabbit broker
            BG_PLUGIN_MQ_HOST: rabbitmq
            BG_MQ_HOST: rabbitmq
            BG_MQ_EXCHANGE: beer_garden
            BG_MQ_CONNECTIONS_ADMIN_USER: beer_garden
            BG_MQ_CONNECTIONS_ADMIN_PASSWORD: password
            BG_MQ_CONNECTIONS_MESSAGE_USER: beer_garden
            BG_MQ_CONNECTIONS_MESSAGE_PASSWORD: password

    mongodb:
        image: mongo:4.2
        networks:
            - mongo
        ports:
          - "27017:27017"
        volumes:
            - mongo-data:/data/db
            - mongo-config:/data/configdb
        
        deploy:
            restart-policy:
                condition: any

    rabbitmq:
        image: rabbitmq:3.8-management-alpine
        hostname: rabbitmq
        networks:
            - rabbit
        environment:
            - RABBITMQ_DEFAULT_USER=beer_garden
            - RABBITMQ_DEFAULT_PASS=password
        ports:
            - "5672:5672"
            - "15672:15672"
        volumes:
            - rabbitmq-home:/var/lib/rabbitmq

        deploy:
            restart-policy:
                condition: any

networks:
    bg-network:
        driver: overlay
        name: bg-network
    mongo:
        driver: overlay
        name: mongo
    rabbit:
        driver: overlay
        name: rabbit

volumes:
    plugins:
    plugin-logs:
    mongo-data:
    mongo-config:
    rabbitmq-home:
