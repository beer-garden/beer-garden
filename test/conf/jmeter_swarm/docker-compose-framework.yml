version: '3.8'

services:
    beer-garden-parent:
        image: bgio/beer-garden:unstable
        deploy:
            restart_policy:
                condition: any
            replicas: 1
        networks:
            - bg-network
            - rabbit
            - mongo
            - activemq
        ports:
            - "2337:2337"

        volumes:
            - ./data/logging-config.yaml:/src/example_configs/logging-config.yaml
            - ./data/localplugins:/plugins
            - ./beer_garden_jmeter_parent_children:/children

        environment:
            TZ: UTC

            # BG_REPLICATION_ENABLED: "true"

            BG_GARDEN_NAME: parent    

            # Point at the correct database
            BG_DB_HOST: mongodb
            BG_DB_NAME: parent

            BG_CHILDREN_CONFIG_DIRECTORY: /children

            # Point at the correct rabbit broker
            BG_PLUGIN_MQ_HOST: rabbitmq
            BG_MQ_HOST: rabbitmq
            BG_MQ_EXCHANGE: parent
            BG_MQ_CONNECTIONS_ADMIN_USER: beer_garden
            BG_MQ_CONNECTIONS_ADMIN_PASSWORD: password
            BG_MQ_CONNECTIONS_MESSAGE_USER: beer_garden
            BG_MQ_CONNECTIONS_MESSAGE_PASSWORD: password

    beer-garden-child:
        image: bgio/beer-garden:unstable
        deploy:
            restart_policy:
                condition: any
            replicas: 1
        networks:
            - bg-network
            - rabbit
            - mongo
            - activemq
        ports:
            - "3337:2337"

        volumes:
            - ./data/logging-config.yaml:/src/example_configs/logging-config.yaml
            - ./data/localplugins:/plugins
            - ./beer_garden_jmeter_parent_children:/children

        environment:
            TZ: UTC

            # BG_REPLICATION_ENABLED: "true"

            BG_GARDEN_NAME: child
            BG_PARENT_SYNC_INTERVAL: 1
            BG_PARENT_STOMP_ENABLED: "true"
            BG_PARENT_STOMP_HOST: activemq
            BG_PARENT_STOMP_USERNAME: beer_garden
            BG_PARENT_STOMP_PASSWORD: password
            BG_PARENT_STOMP_SEND_DESTINATION: Beer_Garden_Operations_Parent
            BG_PARENT_STOMP_SUBSCRIBE_DESTINATION: Beer_Garden_Forward_Parent

            # Point at the correct database
            BG_DB_HOST: mongodb
            BG_DB_NAME: child

            # Point at the correct rabbit broker
            BG_PLUGIN_MQ_HOST: rabbitmq
            BG_MQ_HOST: rabbitmq
            BG_MQ_EXCHANGE: child
            BG_MQ_CONNECTIONS_ADMIN_USER: beer_garden
            BG_MQ_CONNECTIONS_ADMIN_PASSWORD: password
            BG_MQ_CONNECTIONS_MESSAGE_USER: beer_garden
            BG_MQ_CONNECTIONS_MESSAGE_PASSWORD: password

networks:
    bg-network:
        name: bg-network
        external: true
    mongo:
        name: mongo
        external: true
    rabbit:
        name: rabbit
        external: true
    activemq:
        name: activemq
        external: true

volumes:
    plugins:
    plugin-logs:
